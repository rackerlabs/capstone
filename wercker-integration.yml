---

box: ubuntu:14.04
build:
  steps:
    - script:
      name: Install apt requirements
      code: |
        sed "s@archive.ubuntu.com@mirror.rackspace.com@" -i \
            /etc/apt/sources.list
        apt-get update
        # apt-transport-https is only required due to
        # https://bugs.launchpad.net/openstack-ansible/+bug/1547541
        apt-get install -V -y python-dev git-core apt-transport-https curl \
        libssl-dev libffi-dev
    - script:
      name: Get modern pip
      code: curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
    - script:
      name: Install pip
      code: python /tmp/get-pip.py
    - script:
      name: Install pip requirements
      code: pip install "ansible<2" tox
    - script:
      name: Install ansible galaxy requirements
      cwd: /pipeline/source/deploy
      code: ansible-galaxy install -r ansible-role-requirements.yml
    - script:
      name: Populate inventory file
      cwd: /pipeline/source/deploy
      code: export ANSIBLE_INVENTORY=${INVENTORY:-inventory_localhost}
    - script:
      name: Syntax check ansible playbook
      cwd: /pipeline/source/deploy
      code: |
        ansible-playbook --syntax-check -i $ANSIBLE_INVENTORY \
        -e @local_vars.yml deploy.yml
    - script:
      name: Run playbook
      cwd: /pipeline/source/deploy
      code: |
        ansible-playbook -i $ANSIBLE_INVENTORY deploy.yml -e @local_vars.yml
    - script:
      name: Attempt to curl the keystone endpoint
      # at least make sure the keystone service is running
      code: curl --cacert /etc/ssl/certs/keystone.pem https://localhost:8443/
    - script:
      name: Deploy mock v2 service
      cwd: /pipeline/source/deploy
      code: |
        ansible-playbook -i $ANSIBLE_INVENTORY deploy_mock_v2.yml -e @local_vars.yml
    - script:
      name: Setup integration testing requirements
      cwd: /pipeline/source/deploy
      code: |
        ansible-playbook -i $ANSIBLE_INVENTORY setup_integration_test_host.yml
    - script:
      name: Run capstone integration tests
      cwd: /pipeline/source/
      code: tox -e integration
